# Sekai - 拟真地图生成器 需求文档

> **项目代号**: sekai (日语: 世界)
> 
> **项目定位**: 一个能够自动生成拟真地形环境和政治板块的交互式地图编辑器
>
> **参考项目**: [Azgaar's Fantasy Map Generator](https://github.com/Azgaar/Fantasy-Map-Generator)

---

## 一、项目概述

### 1.1 项目目标

创建一个功能强大的地图生成与编辑工具，能够：

1. **自动生成拟真地形** - 基于程序化生成算法，创建逼真的地形（山脉、平原、海洋、河流等）
2. **生成政治板块** - 自动划分国家/地区边界，模拟真实的政治地理格局
3. **交互式编辑** - 支持用户对生成的地图进行自定义修改
4. **多平台支持** - 同时支持桌面原生应用和 Web 浏览器运行

### 1.2 技术架构

| 组件 | 技术选型 | 说明 |
|------|---------|------|
| 编程语言 | Rust | 高性能、内存安全 |
| GUI 框架 | egui / eframe | 即时模式 GUI，支持 Web 和原生 |
| GPU 渲染 | wgpu | 跨平台图形 API |
| 三角剖分 | delaunator | Delaunay 三角剖分库 |
| Web 编译 | Trunk | WASM 编译与打包工具 |
| 并行计算 | rayon | 数据并行计算 |
| 噪声生成 | noise / fastnoise-lite | 程序化噪声生成 |

### 1.3 项目灵感来源

本项目参考了 [Fantasy Map Generator](https://github.com/Azgaar/Fantasy-Map-Generator) 的设计理念，但使用 Rust + GPU 渲染重新实现，以获得更好的性能和跨平台能力。

---

## 二、核心概念

### 2.1 几何基础

#### 2.1.1 网格系统 (Grid)

地图的基础是一个**抖动网格** (Jittered Grid)：

- 在规则网格的基础上添加随机偏移，避免人工感
- 每个网格点代表一个潜在的 Voronoi 单元中心
- 参数：
  - `width` / `height`: 地图尺寸（逻辑单位）
  - `spacing`: 网格间距，决定单元格密度
  - `jittering`: 抖动强度（默认为 spacing 的 45%）

#### 2.1.2 Delaunay 三角剖分

将网格点连接成三角形网络：

- 保证任意三角形的外接圆内不包含其他点
- 作为 Voronoi 图的对偶图
- 用于地形高度插值和邻接关系计算

#### 2.1.3 Voronoi 图

基于 Delaunay 三角剖分生成：

- 每个 Voronoi 单元对应一个网格点
- 单元边界是相邻三角形外心的连线
- 形成自然、不规则的多边形区域
- 作为地图的基本地理单元（Cell）

```
┌─────────────────────────────────────────┐
│         Voronoi 单元示意图              │
│                                         │
│    ╱╲      ╱╲      ╱╲                   │
│   ╱  ╲    ╱  ╲    ╱  ╲                  │
│  ╱ ·  ╲  ╱ ·  ╲  ╱ ·  ╲   · = 单元中心  │
│  ╲    ╱  ╲    ╱  ╲    ╱                 │
│   ╲  ╱    ╲  ╱    ╲  ╱                  │
│    ╲╱      ╲╱      ╲╱                   │
└─────────────────────────────────────────┘
```

### 2.2 分层数据模型

地图数据采用分层架构，每一层负责特定的地理或政治属性：

```
┌─────────────────────────────────────────────────────────────┐
│                     渲染/可视化层                            │
├─────────────────────────────────────────────────────────────┤
│  标注层 (Labels)      │ 地名、城市名、区域名称                │
│  路线层 (Routes)      │ 道路、航线、贸易路线                  │
│  军事层 (Military)    │ 军事设施、防御工事                    │
│  城镇层 (Burgs)       │ 城市、城镇、村庄、定居点              │
├─────────────────────────────────────────────────────────────┤
│                     政治/社会层                              │
├─────────────────────────────────────────────────────────────┤
│  宗教层 (Religions)   │ 信仰区域分布                         │
│  省份层 (Provinces)   │ 行政区划                             │
│  国家层 (States)      │ 政治实体、国境线                      │
│  文化层 (Cultures)    │ 文化区域、民族分布                    │
├─────────────────────────────────────────────────────────────┤
│                     自然地理层                               │
├─────────────────────────────────────────────────────────────┤
│  生物群落层 (Biomes)  │ 生态区域（森林、沙漠等）              │
│  气候层 (Climate)     │ 温度、降水、风向                      │
│  水系层 (Rivers)      │ 河流、湖泊、瀑布                      │
│  海陆层 (Coastline)   │ 海岸线、岛屿、半岛                    │
│  高度层 (Heightmap)   │ 地形高度、山脉、平原                  │
├─────────────────────────────────────────────────────────────┤
│                     基础几何层                               │
├─────────────────────────────────────────────────────────────┤
│  Voronoi 单元格       │ 基本地理单元                         │
│  Delaunay 三角形      │ 邻接关系                             │
│  网格点 (Grid)        │ 采样点                               │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 数据模型

#### 2.3.1 单元格数据 (CellsData)

每个 Voronoi 单元存储的属性：

| 属性 | 类型 | 说明 | 生成阶段 |
|------|------|------|---------|
| `height` | u8 | 高度值 (0-255)，20为海平面 | Phase 1 |
| `temperature` | i8 | 温度 (-128°C ~ 127°C) | Phase 2 |
| `precipitation` | u8 | 年降水量 (0-255 映射到 mm) | Phase 2 |
| `biome` | u16 | 生物群落 ID | Phase 2 |
| `flux` | u16 | 水流量（河流计算用） | Phase 1 |
| `state` | u16 | 国家/政治实体 ID | Phase 3 |
| `culture` | u16 | 文化区域 ID | Phase 3 |
| `religion` | u16 | 宗教区域 ID | Phase 3 |
| `province` | u16 | 省份/行政区 ID | Phase 3 |
| `population` | u32 | 人口数量 | Phase 4 |
| `harbor` | u8 | 港口等级 (0=无) | Phase 4 |

#### 2.3.2 边数据 (EdgesData)

存储 Voronoi 边的属性：

| 属性 | 类型 | 说明 |
|------|------|------|
| `river_id` | u16 | 河流 ID (0=无河流) |
| `river_width` | u8 | 河流宽度 |
| `is_border` | bool | 是否为边界 |
| `border_type` | u8 | 边界类型（国境/省界等） |

#### 2.3.3 特征系统 (Feature System)

##### 区域特征 (RegionFeature)

```rust
struct RegionFeature {
    id: u16,
    name: String,
    color: Color32,
    cells: Vec<u32>,        // 包含的单元格索引
    center: Option<u32>,    // 中心单元格（如首都所在）
    area: f32,              // 面积
    perimeter: Vec<u32>,    // 边界单元格
}
```

##### 线性特征 (LinearFeature)

```rust
struct LinearFeature {
    id: u16,
    name: String,
    feature_type: LinearFeatureType,  // River, Road, Route
    path: Vec<u32>,                   // 经过的单元格/边
    width: f32,
    source: Option<u32>,              // 起点
    mouth: Option<u32>,               // 终点
}
```

##### 点特征 (PointFeature)

| 特征类型 | 说明 | 属性 |
|---------|------|------|
| `City` | 城市 | 人口、等级、港口、城堡 |
| `Town` | 城镇 | 人口、类型 |
| `Village` | 村庄 | 人口 |
| `Marker` | 标记点 | 图标、描述 |

---

## 三、功能需求详细

### 3.1 Phase 1: 地形生成 🚧

#### 3.1.1 高度图生成

**目标**: 生成自然、多样化的地形高度分布

**主要算法：板块构造模拟** ⭐

采用板块构造（Plate Tectonics）模拟作为主要高度图生成算法，这是最接近真实地质过程的方式：

```
┌─────────────────────────────────────────────────────────────────────┐
│                    板块构造模拟流程                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. 板块生成                                                         │
│     • 随机放置 N 个板块种子点（默认 12-15 个）                        │
│     • 使用 Voronoi 划分板块区域                                      │
│     • 分配板块类型（大陆板块/海洋板块）                               │
│                                                                      │
│  2. 运动分配                                                         │
│     • 为每个板块分配运动方向和速度                                    │
│     • 可选：板块旋转                                                 │
│                                                                      │
│  3. 边界分析                                                         │
│     • 汇聚边界（碰撞）→ 造山/俯冲带                                  │
│     • 分离边界（张裂）→ 裂谷/洋脊                                    │
│     • 转换边界（错动）→ 断层                                        │
│                                                                      │
│  4. 高度更新（多次迭代模拟地质时间）                                  │
│     • 碰撞区域隆起形成山脉                                           │
│     • 俯冲区域下沉形成海沟                                           │
│     • 分离区域产生裂谷                                               │
│     • 应用地壳均衡调整                                               │
│                                                                      │
│  5. 后处理                                                           │
│     • 添加噪声细节                                                   │
│     • 平滑处理                                                       │
│     • 可选：侵蚀模拟                                                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**板块类型**:

| 类型 | 密度 | 特点 |
|------|------|------|
| 大陆板块 | 2.7 g/cm³ | 较轻，浮力大，形成大陆 |
| 海洋板块 | 3.0 g/cm³ | 较重，易俯冲到大陆板块下 |

**边界类型与地形效果**:

| 边界类型 | 相对运动 | 地形效果 | 典型实例 |
|---------|---------|---------|---------|
| 汇聚（大陆-大陆）| 相向 | 高大褶皱山脉 | 喜马拉雅山 |
| 汇聚（海洋-大陆）| 相向 | 海沟+火山弧 | 日本海沟 |
| 汇聚（海洋-海洋）| 相向 | 海沟+岛弧 | 马里亚纳海沟 |
| 分离 | 背向 | 裂谷/洋中脊 | 大西洋中脊 |
| 转换 | 平行错动 | 断层 | 圣安德烈斯断层 |

**实现要点**:
- [ ] 板块生成与 Voronoi 划分
- [ ] 板块运动向量分配
- [ ] 边界类型分析（汇聚/分离/转换）
- [ ] 碰撞隆起与俯冲下沉计算
- [ ] 地壳均衡（Isostasy）调整
- [ ] 迭代模拟（100-300次代表地质时间）
- [ ] 后处理噪声细节添加
- [ ] 高度值归一化到 0-255

**用户参数**:

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `plate_count` | 板块数量 | 12 |
| `continental_ratio` | 大陆板块比例 | 0.4 |
| `iterations` | 模拟迭代次数 | 100 |
| `collision_uplift_rate` | 碰撞隆起速率 | 0.5 |
| `subduction_depth_rate` | 俯冲下沉速率 | 0.3 |
| `noise_strength` | 噪声细节强度 | 0.3 |
| `seed` | 随机种子 | - |

**预设配置**:

| 预设 | 板块数 | 大陆比例 | 迭代次数 | 效果 |
|------|--------|---------|---------|------|
| 类地球 | 15 | 0.3 | 200 | 均衡的大陆分布 |
| 多山地 | 20 | 0.5 | 300 | 复杂的山脉系统 |
| 群岛 | 25 | 0.2 | 150 | 分散的岛屿 |
| 超级大陆 | 8 | 0.6 | 250 | 一个巨大的连续大陆 |

**备选算法**:

| 算法 | 适用场景 | 特点 |
|------|---------|------|
| Perlin/Simplex 噪声 | 快速原型/简单地图 | 生成快但不够真实 |
| 模板+噪声 | 自定义大陆形状 | 用户可控 |

#### 3.1.2 海陆分布

**目标**: 基于高度图划分海洋与陆地

**规则**:
- 海平面阈值：height = 20（可配置）
- height < 20: 海洋/水体
- height >= 20: 陆地

**特殊处理**:
- [ ] 检测并标记孤立水体（湖泊候选）
- [ ] 检测并标记孤立陆地（岛屿）
- [ ] 计算海岸线（海陆交界的边）
- [ ] 分离大陆与岛屿

**数据结构**:
```rust
struct Landmass {
    id: u16,
    cells: Vec<u32>,
    is_continent: bool,  // 面积大于阈值
    coastline: Vec<u32>, // 海岸线单元格
}
```

#### 3.1.3 水系生成

**目标**: 生成自然的河流网络和湖泊

##### 3.1.3.1 河流生成算法

1. **降水分配**: 每个陆地单元格根据高度和气候接收降水
2. **水流汇聚**: 水从高处流向低处，累计流量
3. **河流阈值**: 流量超过阈值的路径成为河流
4. **河口确定**: 河流汇入海洋或湖泊的位置

**实现步骤**:
- [ ] 计算每个单元格的流向（指向最低邻居）
- [ ] 累积流量计算（从高到低遍历）
- [ ] 河流路径提取
- [ ] 河流宽度计算（基于流量）
- [ ] 河流合并（支流汇入干流）

##### 3.1.3.2 湖泊生成

- [ ] 检测地形凹陷（四周都比中心高）
- [ ] 填充凹陷形成湖泊
- [ ] 湖泊溢出（找到最低出口点）
- [ ] 冰川湖（高海拔低温区域）

##### 3.1.3.3 河流属性

```rust
struct River {
    id: u16,
    name: String,
    source_cell: u32,       // 源头单元格
    mouth_cell: u32,        // 河口单元格
    mouth_type: MouthType,  // Sea, Lake, River（汇入其他河流）
    parent: Option<u16>,    // 汇入的河流 ID
    tributaries: Vec<u16>,  // 支流 ID
    cells: Vec<u32>,        // 经过的单元格
    width_km: f32,          // 河口宽度
    length_km: f32,         // 总长度
}

enum MouthType {
    Sea,
    Lake(u16),    // 湖泊 ID
    River(u16),   // 汇入的河流 ID
}
```

### 3.2 Phase 2: 气候与生物群落

#### 3.2.1 温度系统

**影响因素**:

| 因素 | 权重 | 说明 |
|------|------|------|
| 纬度 | 高 | 赤道热，两极冷 |
| 海拔 | 中 | 每升高1000m降约6.5°C |
| 洋流 | 低 | 暖流升温，寒流降温 |
| 大陆性 | 低 | 内陆温差大 |

**计算公式**:
```
base_temp = 30 - abs(latitude) * 0.6
altitude_effect = -height * 0.026
temp = base_temp + altitude_effect + ocean_current_effect
```

**实现**:
- [ ] 基于 Y 坐标计算纬度
- [ ] 海拔温度修正
- [ ] 可选：洋流系统模拟
- [ ] 温度平滑处理

#### 3.2.2 降水系统

**影响因素**:

| 因素 | 说明 |
|------|------|
| 季风/信风 | 主导风向决定降水分布 |
| 地形 | 迎风坡多雨，背风坡干燥（雨影效应） |
| 距海距离 | 沿海湿润，内陆干燥 |
| 洋流 | 暖流增加降水 |

**简化模型**:
- [ ] 定义主导风向（可配置）
- [ ] 计算各单元格距海距离
- [ ] 应用雨影效应
- [ ] 降水量平滑

#### 3.2.3 生物群落分配

基于温度和降水自动确定生物群落：

```
┌─────────────────────────────────────────────────────────────┐
│                    生物群落分布图                            │
│                                                             │
│  温度↑                                                       │
│   高 │  沙漠    热带草原    热带季雨林   热带雨林           │
│      │                                                       │
│   中 │  温带草原  温带落叶林   温带雨林                      │
│      │                                                       │
│   低 │  寒漠     针叶林（泰加林）                            │
│      │                                                       │
│  极低│  冰原     苔原                                        │
│      └──────────────────────────────────────────────────────│
│            低           中           高        降水量→       │
└─────────────────────────────────────────────────────────────┘
```

**生物群落列表**:

| ID | 名称 | 温度范围 | 降水范围 | 颜色 |
|----|------|---------|---------|------|
| 1 | 冰原 | < -10 | 任意 | #FFFFFF |
| 2 | 苔原 | -10 ~ 0 | < 250mm | #96C8A2 |
| 3 | 针叶林 | 0 ~ 10 | > 250mm | #1E6B52 |
| 4 | 温带草原 | 5 ~ 20 | 250-500mm | #D5C96E |
| 5 | 温带落叶林 | 5 ~ 20 | 500-1500mm | #6B8E23 |
| 6 | 温带雨林 | 10 ~ 20 | > 1500mm | #228B22 |
| 7 | 沙漠 | > 15 | < 250mm | #EDC9AF |
| 8 | 热带草原 | > 20 | 500-1500mm | #C4B454 |
| 9 | 热带季雨林 | > 20 | 1500-2500mm | #4B6F44 |
| 10 | 热带雨林 | > 25 | > 2500mm | #0B6623 |
| 11 | 湿地 | 任意 | 特殊 | #4A6741 |
| 12 | 红树林 | > 20 | 沿海 | #3D5229 |

### 3.3 Phase 3: 政治地理

#### 3.3.1 文化区域生成

**生成逻辑**:
1. 随机放置文化种子点（考虑人口分布）
2. 文化扩张（类似 Voronoi 但受地形影响）
3. 地理屏障限制扩张（山脉、大河、海洋）
4. 文化边界稳定化

**文化属性**:
```rust
struct Culture {
    id: u16,
    name: String,
    type_: CultureType,     // Nomadic, River, Coastal, Highland, etc.
    color: Color32,
    expansionism: f32,      // 扩张性 0-1
    cells: Vec<u32>,
    origin_cell: u32,       // 起源地
}

enum CultureType {
    Nomadic,    // 游牧文化（草原）
    River,      // 河流文化
    Coastal,    // 沿海文化
    Highland,   // 高原文化
    Hunting,    // 狩猎文化（森林/苔原）
    Agricultural, // 农耕文化
}
```

#### 3.3.2 国家生成

**生成步骤**:

1. **放置首都候选**:
   - 优先选择港口、河流交汇处、平原地带
   - 考虑现有人口分布
   - 避开极端气候区域

2. **初始领土**:
   - 以首都为中心分配初始领土
   - 受文化边界影响

3. **国家扩张**:
   - 模拟历史扩张过程
   - 扩张成本计算（地形、距离、文化差异）
   - 自然边界形成（山脉、河流）

4. **边界优化**:
   - 消除飞地
   - 稳定边界线
   - 处理包围地

**国家属性**:
```rust
struct State {
    id: u16,
    name: String,
    form: GovernmentForm,   // Monarchy, Republic, Theocracy, etc.
    color: Color32,
    capital: u32,           // 首都 Burg ID
    cells: Vec<u32>,
    provinces: Vec<u16>,    // 省份 ID 列表
    culture: u16,           // 主体文化
    neighbors: Vec<u16>,    // 邻国
    coastline: f32,         // 海岸线长度
    area: f32,
    population: u32,
}

enum GovernmentForm {
    Monarchy,
    Republic,
    Theocracy,
    Tribal,
    Empire,
}
```

#### 3.3.3 省份划分

**规则**:
- 每个国家自动划分为若干省份
- 省份大小与国家面积成比例
- 省份边界优先沿自然地形
- 每个省份有省会城市

#### 3.3.4 宗教分布

**生成逻辑**:
- 宗教起源地（圣地）
- 基于文化和国家传播
- 宗教竞争与融合
- 国教系统

### 3.4 Phase 4: 城镇与路网

#### 3.4.1 城市放置

**选址因素**:

| 因素 | 权重 | 说明 |
|------|------|------|
| 河流 | 高 | 靠近河流加分 |
| 港口 | 高 | 天然港口位置 |
| 地形 | 中 | 平原优于山区 |
| 资源 | 中 | 矿产、农业用地 |
| 交通 | 中 | 交叉路口、关隘 |
| 安全 | 低 | 易守难攻的位置 |

**城市等级**:

| 等级 | 类型 | 人口范围 | 设施 |
|------|------|---------|------|
| 1 | 首都 | > 500,000 | 城堡、港口、市场 |
| 2 | 大城市 | 100,000-500,000 | 可选城堡、港口 |
| 3 | 城市 | 20,000-100,000 | 市场 |
| 4 | 城镇 | 5,000-20,000 | - |
| 5 | 村庄 | < 5,000 | - |

**城市属性**:
```rust
struct Burg {
    id: u16,
    name: String,
    cell: u32,              // 所在单元格
    state: u16,             // 所属国家
    culture: u16,           // 所属文化
    population: u32,
    is_capital: bool,
    is_port: bool,
    citadel: bool,          // 有城堡
    walls: bool,            // 有城墙
    plaza: bool,            // 有广场/市场
    temple: bool,           // 有神庙
    shanty_town: bool,      // 有贫民区
}
```

#### 3.4.2 道路网络

**道路类型**:

| 类型 | 优先级 | 说明 |
|------|--------|------|
| 主干道 | 1 | 连接首都与大城市 |
| 次干道 | 2 | 连接城市 |
| 地方道路 | 3 | 连接城镇 |
| 小径 | 4 | 连接村庄 |
| 贸易路线 | 特殊 | 跨国贸易路线 |

**路径算法**:
- 使用 A* 算法寻找最短路径
- 成本函数考虑地形（山地高、平原低）
- 优先使用现有道路
- 避开水体（除非有桥/渡口）

#### 3.4.3 航线

- 连接港口城市
- 考虑洋流和风向
- 避开危险水域

### 3.5 Phase 5: 渲染系统 ✅ 进行中

#### 3.5.1 基础渲染 ✅

- [x] 网格点渲染
- [x] Delaunay 三角剖分线框渲染
- [x] Voronoi 边界渲染
- [x] GPU 加速渲染 (wgpu)
- [x] 着色器 (WGSL)

#### 3.5.2 图层系统

| 图层 | 渲染内容 | Z-Order |
|------|---------|---------|
| 基础网格 | Voronoi/Delaunay 边 | 0 |
| 地形高度 | 单元格填充色 | 10 |
| 海洋 | 海洋区域填充 | 11 |
| 河流湖泊 | 河流线、湖泊填充 | 20 |
| 生物群落 | 单元格着色 | 30 |
| 政治边界 | 国境线、省界 | 40 |
| 文化区域 | 虚线边界 | 41 |
| 道路 | 道路线 | 50 |
| 城市图标 | 点精灵 | 60 |
| 标注 | 文字 | 70 |

**图层功能**:
- [ ] 多图层渲染架构
- [ ] 图层可见性切换
- [ ] 图层透明度调节
- [ ] 图层渲染顺序

#### 3.5.3 地形可视化

| 模式 | 说明 |
|------|------|
| 高度图 | 连续颜色渐变（深蓝-浅蓝-绿-棕-白） |
| 等高线 | 等间隔高度线 |
| 山体阴影 | 基于光照方向的阴影 |
| 坡度图 | 显示地形陡峭程度 |

#### 3.5.4 政治地图可视化

- [ ] 国家边界线（实线）
- [ ] 国家填充色（带透明度）
- [ ] 省份边界（虚线）
- [ ] 争议地区（特殊标记）
- [ ] 首都/城市图标
- [ ] 地名标注

### 3.6 Phase 6: 交互功能 ✅ 部分完成

#### 3.6.1 画布操作 ✅

- [x] 平移 (Pan) - 空格键 + 拖拽 或 滚轮
- [x] 缩放 (Zoom) - 鼠标滚轮 / 触控板捏合
- [x] 缩放限制 (0.1x - 100x)

#### 3.6.2 编辑工具

| 工具 | 功能 | 快捷键 |
|------|------|--------|
| 笔刷 | 绘制地形高度 | B |
| 橡皮 | 降低地形/删除 | E |
| 选择 | 选中单元格 | S |
| 填充 | 区域填充 | F |
| 吸管 | 拾取属性 | I |
| 河流 | 绘制河流 | R |
| 路线 | 绘制道路 | T |

**笔刷系统**:
- [ ] 可调大小（1-50 单元格）
- [ ] 笔刷形状（圆形/方形）
- [ ] 笔刷强度/透明度
- [ ] 平滑模式

#### 3.6.3 信息查看

- [ ] 悬停显示单元格信息（高度、温度、国家等）
- [ ] 点击选中查看详细信息面板
- [ ] 坐标显示
- [ ] 迷你地图（概览）
- [ ] 测量工具（距离、面积）

#### 3.6.4 历史与撤销

- [ ] 撤销 (Ctrl+Z)
- [ ] 重做 (Ctrl+Y)
- [ ] 历史记录面板
- [ ] 快照保存

### 3.7 Phase 7: 导入导出

#### 3.7.1 项目文件

- [ ] 保存为项目文件（.sekai）
- [ ] 自动保存
- [ ] 版本迁移

#### 3.7.2 导出格式

| 格式 | 用途 |
|------|------|
| PNG | 静态地图图片 |
| SVG | 矢量地图 |
| JSON | 数据交换 |
| GeoJSON | GIS 兼容 |
| Heightmap PNG | 高度图灰度图 |

#### 3.7.3 导入功能

- [ ] 导入高度图
- [ ] 导入海岸线模板
- [ ] 导入 Azgaar FMG 文件（兼容性）

---

## 四、UI 设计需求

### 4.1 主界面布局

```
┌────────────────────────────────────────────────────────────────────────┐
│ [文件] [编辑] [视图] [生成] [图层] [工具] [帮助]      🌓 主题    ⚙ 设置 │
├────────────┬───────────────────────────────────────────────┬───────────┤
│            │                                               │           │
│   工具箱   │                                               │  信息    │
│  ────────  │                                               │  面板    │
│  🖌️ 笔刷   │                                               │ ──────── │
│  🧽 橡皮   │                                               │ 单元格:  │
│  🔲 选择   │                                               │ #12345   │
│  🪣 填充   │                                               │          │
│  💧 河流   │              地 图 画 布                       │ 高度: 45 │
│  🛤️ 道路   │                                               │ 温度: 18°│
│            │                                               │ 降水:800 │
│  ────────  │                                               │ 生物群落:│
│  图层列表  │                                               │  温带林  │
│  ☑ 高度    │                                               │          │
│  ☑ 海岸    │                                               │ 国家:    │
│  ☑ 河流    │                                               │  王国A   │
│  ☑ 生物群落│                                               │ 文化:    │
│  ☑ 政治    │                                               │  文化A   │
│  ☑ 城市    │                                               │          │
│  ☑ 道路    │                                               │          │
│  ☐ 网格    │                                               │          │
│            │                                               │          │
├────────────┴───────────────────────────────────────────────┴───────────┤
│ 状态: 就绪 | 坐标: (1234, 567) | 缩放: 100% | 单元格: 20,000 | 60 FPS  │
└────────────────────────────────────────────────────────────────────────┘
```

### 4.2 生成配置面板

```
┌─────────────────────────────────────┐
│ 🗺️ 地图生成设置                     │
├─────────────────────────────────────┤
│                                     │
│ ▼ 基础设置                          │
│   地图尺寸                          │
│     宽度: [____4096____] px         │
│     高度: [____2048____] px         │
│                                     │
│   网格密度                          │
│     间距: [_____10_____] px         │
│     预估单元格: ~83,000             │
│                                     │
│   随机种子                          │
│     [________12345________] 🎲      │
│                                     │
│ ▼ 地形设置                          │
│   海陆比例: [======●===] 40% 陆地  │
│   山地比例: [==●=======] 20%       │
│   岛屿数量: [====●=====] 中等      │
│   地形模板: [▼ 无模板  ▼]          │
│                                     │
│ ▼ 气候设置                          │
│   温度: [=====●====] 温和          │
│   降水: [=====●====] 适中          │
│   极地范围: [=●=======] 小         │
│                                     │
│ ▼ 政治设置                          │
│   国家数量: [___15___]             │
│   城市密度: [====●=====] 中等      │
│   文化数量: [____8____]            │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │       [  🎲 生成地图  ]         │ │
│ │                                 │ │
│ │  [ 只生成地形 ] [ 完整生成 ]    │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 4.3 特征编辑面板

```
┌─────────────────────────────────────┐
│ 👑 国家编辑: 艾尔斯王国             │
├─────────────────────────────────────┤
│                                     │
│ 基本信息                            │
│   名称: [____艾尔斯王国____]       │
│   政体: [▼ 君主制     ▼]           │
│   颜色: [■] #4A90D9                │
│                                     │
│ 统计信息                            │
│   面积: 125,000 km²                │
│   人口: 3,450,000                  │
│   首都: 艾尔斯城                    │
│   城市: 12                         │
│   省份: 5                          │
│                                     │
│ 邻国                                │
│   • 北方帝国                        │
│   • 海滨共和国                      │
│   • 森林部落联盟                    │
│                                     │
│ 操作                                │
│ [重新命名] [更改颜色] [删除国家]   │
└─────────────────────────────────────┘
```

---

## 五、性能需求

### 5.1 渲染性能

| 指标 | 目标值 | 说明 |
|------|-------|------|
| 帧率 | ≥ 60 FPS | 正常交互情况下 |
| 单元格数量 | 支持 100,000+ | 不明显卡顿 |
| 初始加载 | < 5 秒 | 包含完整地图生成 |
| 图层切换 | < 100ms | 即时响应 |

### 5.2 内存使用

| 场景 | 预期内存 |
|------|---------|
| 10,000 单元格 | < 50 MB |
| 50,000 单元格 | < 200 MB |
| 100,000 单元格 | < 500 MB |

### 5.3 优化策略

**已实现**:
- [x] 视口裁剪 - 只渲染可见区域的几何体
- [x] GPU 加速 - 使用 wgpu 进行渲染
- [x] 并行计算 - 使用 rayon 加速 CPU 计算
- [x] 空间索引 - 加速单元格查询和视口裁剪

**待实现**:
- [ ] LOD (Level of Detail) - 缩小时减少细节
- [ ] 分块加载 - 超大地图按需加载
- [ ] 增量更新 - 只更新变化的部分
- [ ] Buffer 复用 - 避免每帧重新分配 GPU Buffer
- [ ] 计算着色器 - GPU 加速生成算法

---

## 六、项目结构

```
sekai/
├── src/
│   ├── main.rs                  # 应用入口
│   ├── lib.rs                   # 库入口
│   ├── app.rs                   # 主应用结构
│   │
│   ├── delaunay/                # Delaunay 三角剖分
│   │   ├── mod.rs
│   │   ├── delaunay.rs          # 三角剖分算法
│   │   ├── voronoi.rs           # Voronoi 图生成
│   │   ├── half_edge.rs         # 半边数据结构
│   │   ├── triangle.rs          # 三角形数据结构
│   │   └── utils.rs             # 工具函数
│   │
│   ├── generators/              # 生成器模块（新增）
│   │   ├── mod.rs
│   │   ├── heightmap.rs         # 高度图生成
│   │   ├── coastline.rs         # 海岸线生成
│   │   ├── rivers.rs            # 河流生成
│   │   ├── climate.rs           # 气候计算
│   │   ├── biomes.rs            # 生物群落分配
│   │   ├── cultures.rs          # 文化区域生成
│   │   ├── states.rs            # 国家生成
│   │   ├── burgs.rs             # 城镇放置
│   │   ├── routes.rs            # 道路生成
│   │   └── names.rs             # 名称生成
│   │
│   ├── gpu/                     # GPU 渲染模块
│   │   ├── mod.rs
│   │   ├── canvas_uniform.rs
│   │   ├── map_renderer.rs
│   │   ├── pipelines.rs
│   │   ├── helpers.rs
│   │   ├── points/              # 点渲染
│   │   ├── delaunay/            # Delaunay 渲染
│   │   ├── voronoi/             # Voronoi 渲染
│   │   ├── terrain/             # 地形渲染（新增）
│   │   ├── rivers/              # 河流渲染（新增）
│   │   ├── borders/             # 边界渲染（新增）
│   │   └── labels/              # 标注渲染（新增）
│   │
│   ├── models/                  # 数据模型
│   │   ├── mod.rs
│   │   ├── map/
│   │   │   ├── mod.rs
│   │   │   ├── grid.rs          # 网格系统
│   │   │   ├── system.rs        # 地图系统
│   │   │   ├── cells_data.rs    # 单元格数据
│   │   │   ├── edges_data.rs    # 边数据（新增）
│   │   │   └── feature.rs       # 特征系统
│   │   ├── features/            # 特征类型（新增）
│   │   │   ├── mod.rs
│   │   │   ├── river.rs
│   │   │   ├── lake.rs
│   │   │   ├── culture.rs
│   │   │   ├── state.rs
│   │   │   ├── province.rs
│   │   │   ├── religion.rs
│   │   │   ├── burg.rs
│   │   │   └── route.rs
│   │   └── map_layer.rs
│   │
│   ├── map_layer/               # 图层定义
│   │   ├── mod.rs
│   │   └── layer_def.rs
│   │
│   ├── resource/                # 资源管理
│   │   ├── mod.rs
│   │   └── resource_impl.rs
│   │
│   ├── spatial/                 # 空间索引
│   │   ├── mod.rs
│   │   ├── edge_index.rs
│   │   └── grid_index.rs
│   │
│   └── ui/                      # UI 组件
│       ├── mod.rs
│       ├── canvas/              # 画布组件
│       │   ├── mod.rs
│       │   ├── canvas.rs
│       │   ├── state.rs
│       │   ├── widget_impl.rs
│       │   └── input/
│       ├── map/                 # 地图 UI
│       │   ├── mod.rs
│       │   └── map_impl.rs
│       ├── panels/              # 面板（新增）
│       │   ├── mod.rs
│       │   ├── toolbar.rs
│       │   ├── layers.rs
│       │   ├── info.rs
│       │   └── generator.rs
│       └── dialogs/             # 对话框（新增）
│           ├── mod.rs
│           ├── export.rs
│           └── settings.rs
│
├── assets/
│   ├── shaders/                 # GPU 着色器
│   │   ├── points.wgsl
│   │   ├── delaunay.wgsl
│   │   ├── voronoi.wgsl
│   │   ├── terrain.wgsl         # 新增
│   │   ├── rivers.wgsl          # 新增
│   │   └── borders.wgsl         # 新增
│   ├── icons/                   # 图标资源（新增）
│   └── fonts/                   # 字体文件（新增）
│
├── docs/
│   ├── REQUIREMENTS.md          # 本文档
│   ├── ARCHITECTURE.md          # 架构文档
│   └── ALGORITHMS.md            # 算法文档（新增）
│
├── benches/
│   └── delaunay.rs
│
├── Cargo.toml
├── Trunk.toml
└── README.md
```

---

## 七、开发路线图

### Phase 1: 地形生成 (当前目标)

- [ ] 高度图生成算法（噪声叠加）
- [ ] 海陆分布检测
- [ ] 高度着色渲染
- [ ] 海岸线提取
- [ ] 河流生成算法
- [ ] 湖泊检测与生成
- [ ] 水系渲染

### Phase 2: 气候与生物群落

- [ ] 温度计算
- [ ] 降水计算
- [ ] 生物群落分配
- [ ] 生物群落可视化

### Phase 3: 政治地理

- [ ] 文化区域生成
- [ ] 国家生成
- [ ] 省份划分
- [ ] 边界渲染
- [ ] 宗教分布

### Phase 4: 城镇与路网

- [ ] 城市放置算法
- [ ] 人口分布计算
- [ ] 道路网络生成
- [ ] 标注系统

### Phase 5: 编辑功能

- [ ] 笔刷工具系统
- [ ] 选择工具
- [ ] 撤销/重做系统
- [ ] 特征编辑面板

### Phase 6: 完善与导出

- [ ] 导出功能
- [ ] 项目保存/加载
- [ ] 性能优化
- [ ] UI 美化

---

## 八、参考资料

### 8.1 算法参考

- [Polygonal Map Generation](http://www-cs-students.stanford.edu/~amitp/game-programming/polygon-map-generation/) - Amit Patel
- [Fantasy Map Generator](https://github.com/Azgaar/Fantasy-Map-Generator) - Azgaar
- [Procedural World Generation](https://www.redblobgames.com/) - Red Blob Games
- [Hydraulic Erosion Simulation](https://www.firespark.de/resources/downloads/implementation%20of%20a%20methode%20for%20hydraulic%20erosion.pdf)
- [River Networks](https://www.redblobgames.com/x/1723-procedural-rivers/)

### 8.2 技术文档

- [egui 文档](https://docs.rs/egui)
- [wgpu 文档](https://docs.rs/wgpu)
- [delaunator-rs](https://docs.rs/delaunator)
- [noise-rs](https://docs.rs/noise)

---

## 九、术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 单元格 | Cell | Voronoi 图中的一个多边形区域 |
| 三角剖分 | Triangulation | 将点集划分为不重叠三角形的过程 |
| 外心 | Circumcenter | 三角形外接圆的圆心 |
| 生物群落 | Biome | 具有相似气候和生态特征的区域 |
| 图层 | Layer | 地图的一个可视化层级 |
| 抖动 | Jittering | 向规则网格添加随机偏移 |
| 水系 | Hydrography | 河流、湖泊等水体系统 |
| 通量 | Flux | 水流量，用于河流计算 |
| 雨影 | Rain Shadow | 山脉背风坡降水减少的效应 |
| 城镇 | Burg | 城市、城镇等定居点的统称 |

---

*文档版本: 2.0*
*最后更新: 2026-01-12*
